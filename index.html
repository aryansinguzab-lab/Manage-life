let settings = {name:"My Life Manager"};
let security = {p:"1234"};
let myChart = null;
const currentYear = new Date().getFullYear();

// --- HELPERS ---
const getAutoDate = () => new Date().toISOString().split("T")[0];
const formatHumanDate = (dateStr) => {
    const options = { month: 'short', day: 'numeric', weekday: 'short' };
    return new Date(dateStr).toLocaleDateString(undefined, options);
};

// --- APP CORE ---
async function initApp() {
    try {
        const s = await db.config.get('settings');
        const sec = await db.config.get('security');
        if(s) settings = s.val;
        if(sec) security = sec.val;
        applySettingsUI();
        initReportYears();
    } catch(e) { console.error("DB Init failed", e); }
}

function doLogin() {
    if(document.getElementById("loginPass").value === security.p) {
        document.getElementById("login").style.display = "none";
        document.getElementById("app").style.display = "block";
        refreshAllUI();
    } else { alert("Access Denied"); }
}

async function refreshAllUI() {
    renderTasks(currentYear);
    renderCashBook(currentYear);
    renderTargets(currentYear);
}

// --- DATA HANDLERS ---
async function submitEntry() {
    const desc = document.getElementById("entDesc").value, amt = document.getElementById("entAmt").value;
    if (!desc || !amt) return;
    await db.entries.add({ d: getAutoDate(), desc, t: document.getElementById("entType").value, a: parseFloat(amt), c: document.getElementById("entCat").value });
    closeModal('entryModal'); renderCashBook(currentYear);
}

async function submitTask() {
    const title = document.getElementById("taskInTitle").value;
    if (!title) return;
    await db.tasks.add({title, completed: false, date: getAutoDate()});
    closeModal('taskModal'); renderTasks(currentYear);
}

async function submitTarget() {
    const title = document.getElementById("targetInTitle").value;
    if (!title) return;
    await db.targets.add({title, status: 'pending', date: getAutoDate()});
    closeModal('targetModal'); renderTargets(currentYear);
}

// --- RENDERING ---
async function renderCashBook(year) {
    const body = document.getElementById("cashRows");
    document.getElementById('ledgerYearLabel').innerText = year;
    let inc = 0, exp = 0;
    const all = await db.entries.toArray();
    body.innerHTML = all.filter(en => new Date(en.d).getFullYear() === year).map(en => {
        const val = Number(en.a) || 0;
        en.t === "income" ? inc += val : exp += val;
        return `<tr><td><small>${formatHumanDate(en.d)}</small></td><td>${en.desc}</td><td style="color:${en.t==='income'?'green':'red'}">${val.toLocaleString()}</td><td><button onclick="delEntry(${en.id})" style="background:red;width:auto;">X</button></td></tr>`;
    }).reverse().join('');
    document.getElementById("totalInc").innerText = inc.toLocaleString();
    document.getElementById("totalExp").innerText = exp.toLocaleString();
    document.getElementById("totalBal").innerText = (inc - exp).toLocaleString();
}

async function renderTasks(year) {
    const list = document.getElementById("taskList");
    const all = await db.tasks.toArray();
    list.innerHTML = all.map(t => `<li style="background:var(--li); margin:8px 0; padding:12px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;">
        <div><span>${t.completed ? '<s>'+t.title+'</s>' : t.title}</span><br><small style="color:gray">${formatHumanDate(t.date)}</small></div>
        <div><button onclick="toggleTask(${t.id})" style="width:auto; background:blue; padding:5px;">âœ“</button> <button onclick="delTask(${t.id})" style="width:auto; background:red; padding:5px;">X</button></div>
    </li>`).join('');
}

async function renderTargets(year) {
    const list = document.getElementById("targetList");
    const all = await db.targets.toArray();
    list.innerHTML = all.map(t => `<li style="background:var(--li); margin:8px 0; padding:12px; border-radius:8px;">${t.title} <span class="status-pill pending">${t.status}</span><br><small style="color:gray">Started: ${formatHumanDate(t.date)}</small></li>`).join('');
}

// --- UI HELPERS ---
async function toggleTask(id) { const t = await db.tasks.get(id); await db.tasks.update(id, {completed: !t.completed}); renderTasks(currentYear); }
async function delTask(id) { await db.tasks.delete(id); renderTasks(currentYear); }
async function delEntry(id) { await db.entries.delete(id); renderCashBook(currentYear); }
async function saveSettings() {
    settings.name = document.getElementById('setBizName').value;
    const np = document.getElementById('newPass').value;
    if(np.trim()) { security.p = np; await db.config.put({key: 'security', val: security}); }
    await db.config.put({key: 'settings', val: settings});
    applySettingsUI(); closeModal('settingsModal');
}
function applySettingsUI() { document.getElementById('dispName').innerText = settings.name; }
function switchView(id) { ['mainDashboard', 'taskView', 'targetView', 'cashView'].forEach(v => document.getElementById(v).style.display = (v === id) ? 'block' : 'none'); }
function openModal(id) { document.getElementById(id).style.display = "flex"; }
function closeModal(id) { document.getElementById(id).style.display = "none"; }
function openEntryModal(t) { document.getElementById('entType').value = t; openModal('entryModal'); }
function openTaskModal() { openModal('taskModal'); }
function openTargetModal() { openModal('targetModal'); }
function toggleTheme() { const t = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark"; document.documentElement.setAttribute("data-theme", t); }
function doLogout() { location.reload(); }
function initReportYears() {
    const sel = document.getElementById('reportYearSelect');
    let options = "";
    for(let i = 2024; i <= 2060; i++) { options += `<option value="${i}" ${i === currentYear ? 'selected' : ''}>${i}</option>`; }
    if(sel) sel.innerHTML = options;
}

// --- CHARTS & DATA MGMT ---
async function updateReportChart() {
    const year = parseInt(document.getElementById('reportYearSelect').value);
    const ctx = document.getElementById("reportChart");
    let incD = new Array(12).fill(0), expD = new Array(12).fill(0);
    const all = await db.entries.toArray();
    all.forEach(en => {
        let dt = new Date(en.d);
        if(dt.getFullYear() === year) {
            let m = dt.getMonth();
            en.t === "income" ? incD[m] += Number(en.a) : expD[m] += Number(en.a);
        }
    });
    if(myChart) myChart.destroy();
    myChart = new Chart(ctx, { type: 'bar', data: { labels: ["J","F","M","A","M","J","J","A","S","O","N","D"], datasets: [{ label: 'In', data: incD, backgroundColor: '#4CAF50' }, { label: 'Out', data: expD, backgroundColor: '#f44336' }] }, options: { responsive: true, maintainAspectRatio: false } });
}
function showYearlyReport() { openModal('reportModal'); updateReportChart(); }

async function exportData() {
    const backupData = { 
        tasks: await db.tasks.toArray(), 
        entries: await db.entries.toArray(), 
        targets: await db.targets.toArray(), 
        config: await db.config.toArray(), 
        date: new Date().toISOString() 
    };
    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `lifemanager_backup.json`;
    a.click();
}
async function importData() {
    const file = document.getElementById('importFile').files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        const data = JSON.parse(e.target.result);
        await db.tasks.clear(); await db.entries.clear(); await db.targets.clear(); await db.config.clear();
        if(data.tasks) await db.tasks.bulkAdd(data.tasks);
        if(data.entries) await db.entries.bulkAdd(data.entries);
        if(data.targets) await db.targets.bulkAdd(data.targets);
        if(data.config) await db.config.bulkAdd(data.config);
        location.reload();
    };
    reader.readAsText(file);
}

initApp();
</script>
</body>
</html>
