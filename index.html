<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Manager</title>
    <link rel="manifest" href="manifest.json">
    <script src="chart.js"></script>
    <script src="dexie.js"></script>
    <style>
:root {
    --bg: #f5f5f5; --card: #fff; --text: #333; --border: #ccc; --li: #eee; --primary: #4CAF50; --accent: #2196F3; --warn: #FF9800;
}
[data-theme="dark"] {
    --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --border: #333; --li: #2d2d2d; --primary: #66bb6a; --accent: #64b5f6;
}
body{font-family:'Segoe UI', Arial, sans-serif; background:var(--bg); color:var(--text); padding:10px; margin:0; transition: 0.3s;}

.top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 10px; }
#topBar{margin-bottom:15px; background:var(--card); padding:15px; border-radius:12px; border: 1px solid var(--border);}

/* Dashboard Border Grouping */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
    gap: 10px;
    margin-bottom: 20px;
    padding: 15px;
    border: 2px solid var(--border);
    border-radius: 16px;
    background: rgba(0,0,0,0.02);
}

.action-card {
    background: var(--card);
    padding: 15px 5px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    cursor: pointer;
    border: 1px solid var(--border);
}
.action-card:active { transform: scale(0.95); background: var(--li); }
.action-card span { font-size: 24px; display: block; margin-bottom: 5px; }

/* Password Toggle Container */
.pass-container { position: relative; width: 100%; }
.toggle-btn { 
    position: absolute; right: 10px; top: 50%; transform: translateY(-50%); 
    background: none; border: none; color: var(--accent); width: auto; padding: 5px; cursor: pointer;
}

.view-screen { display: none; background:var(--bg); min-height: 100vh; }
section{background:var(--card); padding:15px; border-radius:12px; border: 1px solid var(--border); margin-top: 10px;}

button{cursor:pointer; background:var(--primary); color:white; border:none; font-weight:bold; padding:12px; border-radius:8px; width:100%; margin: 5px 0;}
.back-btn { background: #f44336; margin-bottom: 15px; }

input, select, textarea { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid var(--border); border-radius: 8px; background: var(--card); color: var(--text); box-sizing: border-box; font-size: 16px; font-family: inherit; }

table{width:100%; border-collapse:collapse; margin-top:10px; font-size: 0.85em;}
th,td{border:1px solid var(--border); padding:10px; text-align:center}
th{background:var(--primary); color:#fff}

.summary-box { display: flex; justify-content: space-around; background: var(--li); padding: 15px; border-radius: 8px; margin-bottom: 15px; font-weight: bold; border: 1px solid var(--border); }
#login{position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:999}

.modal{position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; z-index:1000}
.modalContent{background:var(--card); padding:20px; border-radius:15px; width:95%; max-width:450px; box-sizing: border-box; overflow-y: auto; max-height: 90vh;}
.status-pill { font-size: 0.75em; padding: 4px 8px; border-radius: 20px; font-weight: bold; }
.pending { background: #FF9800; color: white; }
.backup-zone { background: var(--li); padding: 10px; border-radius: 8px; border: 1px dashed var(--border); margin-top: 15px; }
</style>
</head>
<body>

<div id="login">
    <section style="width: 300px; text-align: center; border:none;">
        <h2 style="margin-bottom:20px;">MY LIFE MANAGER</h2>
        <div class="pass-container">
            <input id="loginPass" type="password" placeholder="Enter Password" autofocus>
            <button type="button" class="toggle-btn" onclick="togglePassword('loginPass')">üëÅÔ∏è</button>
        </div>
        <button onclick="doLogin()">Enter App</button>
        <p style="font-size: 0.8em; opacity: 0.6;"></p>
    </section>
</div>

<div id="app" style="display:none">
    <div id="mainDashboard">
        <div id="topBar">
            <div class="top-row">
                <button onclick="toggleTheme()" style="width:auto; background:#9C27B0; padding:8px 15px; margin:0;">üåì Theme</button>
                <button onclick="doLogout()" style="width:auto; background:#f44336; padding:8px 15px; margin:0;">Exit</button>
            </div>
            <div style="text-align: center;">
                <strong id="dispName" style="font-size: 1.3em; color: var(--primary);">My Life Manager</strong>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="action-card" onclick="openEntryModal('income')" style="border-top: 4px solid #4CAF50;">
                <span>üí∞</span><b>Record Income</b>
            </div>
            <div class="action-card" onclick="openEntryModal('expense')" style="border-top: 4px solid #F44336;">
                <span>üí∏</span><b>Record Expenses</b>
            </div>
            <div class="action-card" onclick="openTaskModal()" style="border-top: 4px solid #FF9800;">
                <span>üìù</span><b>Record To-Do</b>
            </div>
            <div class="action-card" onclick="openTargetModal()" style="border-top: 4px solid #00BCD4;">
                <span>üéØ</span><b>Annual Target</b>
            </div>
            <div class="action-card" onclick="showYearlyReport()" style="border-top: 4px solid #2196F3;">
                <span>üìä</span><b>Report</b>
            </div>
            <div class="action-card" onclick="openModal('settingsModal')" style="border-top: 4px solid #607D8B;">
                <span>‚öôÔ∏è</span><b>Settings</b>
            </div>
        </div>

        <div class="summary-box">
            <div style="color:green;">+ <span id="totalInc">0</span></div>
            <div style="color:red;">- <span id="totalExp">0</span></div>
            <div style="border-left: 2px solid var(--border); padding-left: 10px;">Bal: <span id="totalBal">0</span></div>
        </div>

        <button onclick="switchView('taskView')" style="background:var(--accent)">üìã Open Tasks</button>
        <button onclick="switchView('targetView')" style="background:#0097A7">üéØ Annual Targets</button>
        <button onclick="switchView('cashView')" style="background:var(--accent)">üìñ View My Finances</button>
    </div>
    <div id="taskView" class="view-screen">
        <button class="back-btn" onclick="switchView('mainDashboard')">Back to Dashboard</button>
        <section><h3>My Tasks</h3><ul id="taskList" style="list-style:none; padding:0;"></ul></section>
    </div>
    <div id="targetView" class="view-screen">
        <button class="back-btn" onclick="switchView('mainDashboard')"> Back to Dashboard</button>
        <section><h3>Annual Targets</h3><ul id="targetList" style="list-style:none; padding:0;"></ul></section>
    </div>
  <div id="cashView" class="view-screen">
    <button class="back-btn" onclick="switchView('mainDashboard')"> Back to Dashboard</button>
    <section>
        <h3>Finance Ledger</h3>
        
        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
            <select id="filterMonth" onchange="renderCashBook()" style="flex: 1;">
                <option value="all">All Months</option>
                <option value="0">January</option>
                <option value="1">February</option>
                <option value="2">March</option>
                <option value="3">April</option>
                <option value="4">May</option>
                <option value="5">June</option>
                <option value="6">July</option>
                <option value="7">August</option>
                <option value="8">September</option>
                <option value="9">October</option>
                <option value="10">November</option>
                <option value="11">December</option>
            </select>
            <select id="filterYear" onchange="renderCashBook()" style="flex: 1;"></select>
        </div>

        <div style="overflow-x:auto;">
            <table>
                <thead><tr><th>Date</th><th>Details</th><th>Amt</th><th>‚úñ</th></tr></thead>
                <tbody id="cashRows"></tbody>
            </table>
        </div>
    </section>
</div>

<div class="modal" id="entryModal"><div class="modalContent">
    <h3 id="entryTitle">Add Entry</h3>
    <input id="entDesc" placeholder="Description?">
    <input id="entAmt" type="number" placeholder="Amount">
    <select id="entCat">
        <option value="General">General</option>
        <option value="Bills">Bills</option>
        <option value="Personal">Personal</option>
    </select>
    <input type="hidden" id="entType">
    <button onclick="submitEntry()">Add to Record</button>
    <button onclick="closeModal('entryModal')" style="background:#636e72">Cancel</button>
</div></div>

<div class="modal" id="taskModal"><div class="modalContent">
    <h3>New Task</h3>
    <input id="taskInTitle" placeholder="Task Name">
    <select id="taskInCat"><option value="General">General</option></select>
    <textarea id="taskInNotes" placeholder="Notes..." rows="2"></textarea>
    <button onclick="submitTask()" style="background:var(--warn)">Save Task</button>
    <button onclick="closeModal('taskModal')" style="background:#636e72">Cancel</button>
</div></div>

<div class="modal" id="targetModal"><div class="modalContent">
    <h3>New Target</h3>
    <input id="targetInTitle" placeholder="Target Name">
    <button onclick="submitTarget()" style="background:#00BCD4">Add Target</button>
    <button onclick="closeModal('targetModal')" style="background:#636e72">Cancel</button>
</div></div>

<div class="modal" id="settingsModal"><div class="modalContent">
    <h3>Profile Settings</h3>
    <label>User Name:</label>
    <input id="setBizName" placeholder="Your Name">
    <label>Change Password:</label>
    <div class="pass-container">
        <input id="newPass" type="password" placeholder="New Password">
        <button type="button" class="toggle-btn" onclick="togglePassword('newPass')">üëÅÔ∏è</button>
    </div>
    <button onclick="saveSettings()">Apply Changes</button>
    
    <div class="backup-zone">
        <h4>Data Management</h4>
        <button onclick="exportData()" style="background: #607D8B;">üíæ Backup to File</button>
        <hr style="margin: 15px 0; border: 0.5px solid var(--border);">
        <input type="file" id="importFile" accept=".json" style="font-size: 0.7em; padding: 5px;">
        <button onclick="importData()" style="background: var(--warn);">üì• Restore Data</button>
    </div>
    <button onclick="closeModal('settingsModal')" style="background:#636e72; margin-top: 15px;">Close</button>
</div></div>

<div class="modal" id="reportModal"><div class="modalContent" style="max-width: 95%;">
    <h3>Report Analysis</h3>
    <select id="reportYearSelect" onchange="updateReportChart()"></select>
    <div style="height: 250px; margin-top:15px;"><canvas id="reportChart"></canvas></div>
    <button onclick="closeModal('reportModal')" style="background:#f44336; margin-top:15px;">Close</button>
</div></div>

<script>
const db = new Dexie("LifeManagerDB");
db.version(2).stores({
    tasks: '++id, date, completed',
    entries: '++id, d, t',
    targets: '++id, date, status',
    config: 'key'
});

let settings = {name:"My Life Manager"};
let security = {p:"1234"};
let myChart = null;
const currentYear = new Date().getFullYear();

// Toggle Password visibility
function togglePassword(id) {
    const input = document.getElementById(id);
    input.type = input.type === "password" ? "text" : "password";
}


async function exportData() {
    const backupData = {
        tasks: await db.tasks.toArray(),
        entries: await db.entries.toArray(),
        targets: await db.targets.toArray(),
        config: await db.config.toArray(),
        date: new Date().toISOString()
    };
    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `lifemanager_backup.json`;
    a.click();
}

async function importData() {
    const fileInput = document.getElementById('importFile');
    if (!fileInput.files[0]) return alert("Select a file first.");
    const reader = new FileReader();
    reader.onload = async (e) => {
        const data = JSON.parse(e.target.result);
        await db.tasks.clear(); await db.entries.clear(); await db.targets.clear(); await db.config.clear();
        if(data.tasks) await db.tasks.bulkAdd(data.tasks);
        if(data.entries) await db.entries.bulkAdd(data.entries);
        if(data.targets) await db.targets.bulkAdd(data.targets);
        if(data.config) await db.config.bulkAdd(data.config);
        location.reload();
    };
    reader.readAsText(fileInput.files[0]);
}

function initReportYears() {
    const sel = document.getElementById('reportYearSelect');
    let options = "";
    for(let i = 2024; i <= 2030; i++) {
        options += `<option value="${i}" ${i === currentYear ? 'selected' : ''}>${i}</option>`;
    }
    sel.innerHTML = options;
}

function doLogin() {
    if(document.getElementById("loginPass").value === security.p) {
        document.getElementById("login").style.display = "none";
        document.getElementById("app").style.display = "block";
        refreshAllUI();
    } else { alert("Access Denied"); }
}

function getToday() { return new Date().toISOString().split("T")[0]; }

async function refreshAllUI() {
    renderTasks(currentYear);
    renderCashBook(currentYear);
    renderTargets(currentYear);
}



async function submitEntry() {
    const descEl = document.getElementById("entDesc");
    const amtEl = document.getElementById("entAmt");
    const catEl = document.getElementById("entCat");
    
    if (!descEl.value || !amtEl.value) return;

    await db.entries.add({ 
        d: getToday(), 
        desc: descEl.value, 
        t: document.getElementById("entType").value, 
        a: parseFloat(amtEl.value), 
        c: catEl.value 
    });

    // Clear Fields
    descEl.value = "";
    amtEl.value = "";
    catEl.selectedIndex = 0;

    closeModal('entryModal'); 
    renderCashBook(currentYear);
}

async function submitTask() {
    const titleEl = document.getElementById("taskInTitle");
    const notesEl = document.getElementById("taskInNotes");

    if (!titleEl.value) return;

    await db.tasks.add({
        title: titleEl.value, 
        completed: false, 
        date: getToday(),
        notes: notesEl.value
    });

    // Clear Fields
    titleEl.value = "";
    notesEl.value = "";

    closeModal('taskModal'); 
    renderTasks(currentYear);
}

async function submitTarget() {
    const titleEl = document.getElementById("targetInTitle");

    if (!titleEl.value) return;

    await db.targets.add({
        title: titleEl.value, 
        status: 'pending', 
        date: getToday()
    });

    // Clear Field
    titleEl.value = "";

    closeModal('targetModal'); 
    renderTargets(currentYear);
}

async function renderTasks(year) {
    const list = document.getElementById("taskList");
    // Get current year from filter if you want tasks separated by year, 
    // otherwise this shows all tasks.
    const all = await db.tasks.toArray();
    
    list.innerHTML = all.map(t => `<li style="background:var(--li); margin:8px 0; padding:12px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;">
        <span style="${t.completed ? 'text-decoration:line-through; opacity:0.5' : ''}">${t.title}</span>
        <div style="display: flex; gap: 5px;">
            <button onclick="toggleTask(${t.id})" style="width:auto; background:var(--accent); padding:5px 10px; margin:0;">
                ${t.completed ? '‚Ü©Ô∏è' : '‚úÖ'}
            </button> 
            <button onclick="delTask(${t.id})" style="width:auto; background:#f44336; padding:5px 10px; margin:0;">
                üóëÔ∏è
            </button>
        </div>
    </li>`).join('');
}



async function initApp() {
    try {
        const s = await db.config.get('settings');
        const sec = await db.config.get('security');
        if(s) settings = s.val;
        if(sec) security = sec.val;
        
        // Populate Year Dropdown up to 2100
        const yearSel = document.getElementById('filterYear');
        if (yearSel) {
            let yearOpts = "";
            for(let i = 2024; i <= 2100; i++) {
                yearOpts += `<option value="${i}" ${i === currentYear ? 'selected' : ''}>${i}</option>`;
            }
            yearSel.innerHTML = yearOpts;
        }

        applySettingsUI();
        initReportYears();
        
        // Initial render of the ledger data
        renderCashBook(); 

    } catch(e) { 
        console.error("DB Init failed", e); 
    }
}

// 2. Updated renderCashBook to handle Month and Year filters


async function renderCashBook() {
    const body = document.getElementById("cashRows");
    const filterYear = document.getElementById("filterYear");
    const filterMonth = document.getElementById("filterMonth");

    // Safety check: if filters don't exist yet, stop
    if (!filterYear || !filterMonth) return;

    const selYear = parseInt(filterYear.value);
    const selMonth = filterMonth.value; 
    
    let inc = 0, exp = 0;
    const all = await db.entries.toArray();
    
    body.innerHTML = all.filter(en => {
        const entryDate = new Date(en.d);
        const matchYear = entryDate.getFullYear() === selYear;
        const matchMonth = (selMonth === "all") || (entryDate.getMonth() === parseInt(selMonth));
        return matchYear && matchMonth;
    }).map(en => {
        const val = Number(en.a) || 0;
        en.t === "income" ? inc += val : exp += val;
        return `<tr>
            <td><small>${en.d}</small></td>
            <td>${en.desc} <br><span class="cat-tag" style="background:var(--li); color:var(--text); border:1px solid var(--border);">${en.c || 'General'}</span></td>
            <td style="color:${en.t==='income'?'green':'red'}">${val.toLocaleString()}</td>
            <td><button onclick="delEntry(${en.id})" style="background:red;width:auto;padding:5px 10px; margin:0;">X</button></td>
        </tr>`;
    }).reverse().join('');

    // Update Summary Boxes
    document.getElementById("totalInc").innerText = inc.toLocaleString();
    document.getElementById("totalExp").innerText = exp.toLocaleString();
    document.getElementById("totalBal").innerText = (inc - exp).toLocaleString();
}


async function renderTargets(year) {
    const list = document.getElementById("targetList");
    const all = await db.targets.toArray();
    list.innerHTML = all.map(t => `<li style="background:var(--li); margin:8px 0; padding:12px; border-radius:8px;">${t.title} <span class="status-pill pending">${t.status}</span></li>`).join('');
}

async function toggleTask(id) { const t = await db.tasks.get(id); await db.tasks.update(id, {completed: !t.completed}); renderTasks(currentYear); }
async function delTask(id) { await db.tasks.delete(id); renderTasks(currentYear); }
async function delEntry(id) { await db.entries.delete(id); renderCashBook(currentYear); }

async function saveSettings() {
    settings.name = document.getElementById('setBizName').value;
    const np = document.getElementById('newPass').value;
    if(np.trim()) { security.p = np; await db.config.put({key: 'security', val: security}); }
    await db.config.put({key: 'settings', val: settings});
    applySettingsUI(); closeModal('settingsModal');
}

function applySettingsUI() { document.getElementById('dispName').innerText = settings.name; document.getElementById('setBizName').value = settings.name; }
function switchView(id) { ['mainDashboard', 'taskView', 'targetView', 'cashView'].forEach(v => document.getElementById(v).style.display = (v === id) ? 'block' : 'none'); }
function openModal(id) { document.getElementById(id).style.display = "flex"; }
function closeModal(id) { document.getElementById(id).style.display = "none"; }
function openEntryModal(t) { document.getElementById('entType').value = t; openModal('entryModal'); }
function openTaskModal() { openModal('taskModal'); }
function openTargetModal() { openModal('targetModal'); }
function toggleTheme() { const t = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark"; document.documentElement.setAttribute("data-theme", t); }
function showYearlyReport() { openModal('reportModal'); updateReportChart(); }
function doLogout() { location.reload(); }

async function updateReportChart() {
    const year = parseInt(document.getElementById('reportYearSelect').value);
    const ctx = document.getElementById("reportChart");
    let incD = new Array(12).fill(0), expD = new Array(12).fill(0);
    const all = await db.entries.toArray();
    all.forEach(en => {
        let dt = new Date(en.d);
        if(dt.getFullYear() === year) {
            let m = dt.getMonth();
            en.t === "income" ? incD[m] += Number(en.a) : expD[m] += Number(en.a);
        }
    });
    if(myChart) myChart.destroy();
    myChart = new Chart(ctx, { type: 'bar', data: { labels: ["J","F","M","A","M","J","J","A","S","O","N","D"], datasets: [{ label: 'In', data: incD, backgroundColor: '#4CAF50' }, { label: 'Out', data: expD, backgroundColor: '#f44336' }] }, options: { responsive: true, maintainAspectRatio: false } });
}

initApp();
</script>
</body>
</html>
